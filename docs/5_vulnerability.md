# Table of Contents
0. [Introduction](../README.md#introduction)
1. [Setup](./1_setup.md)
2. [Emulation](./2_emulation.md)
3. [Tracing](./3_tracing.md)
4. [Symbolic Execution](./4_symbex.md)
5. [Vulnerability CVE-2022-27646](./5_vulnerability.md#vulnerability-cve-2022-27646)
    1. [Description](./5_vulnerability.md#description)
    2. [Analysis](./5_vulnerability.md#analysis)
    3. [Memory Layout PoV](./5_vulnerability.md#memory-layout-pov)
6. [Exploitation](./6_exploitation.md)
<!--TODO--------------------------------------------------------------------------------------------
- [X] Maybe move to 5_vulnerability.md
- [ ] What is the size of stack buffer `line`?
- [ ] Write text
    - [X] Pre-auth remote code execution vulnerability in NETGEAR R6700v3 routers over the WAN interface
    - [X] The vulnerability resides in binary `/bin/circled`, which occasionally fetches a file named `circleinfo.txt` from remote web servers. When parsed by the binary `circled`, a stack buffer overflow (CVE-2022-27646) can be triggered. Since the download requests from the routers miss certificate validation (CVE-2022-27644), attackers could trick routers to download malicious files (e.g. using DNS or TCP redirection), leading to arbitrary code execution on the routers. Since `circled` runs as root, attackers may gain full privileges on the routers.
    - [ ]SHA1 of `/bin/circled`: ac86472cdeccd01165718b1b759073b9e6b665e9
    - [ ] In case of a crash, the binary restarts (used to defeat ASRL)
    - [ ] Read file `circleinfo.txt` line by line (`fgets` - 1024 bytes), parse two strings per line (`sscanf`) and write them to two stack variables (size 256) without size checking -> stack buffer overflow
--------------------------------------------------------------------------------------------------->
# Vulnerability CVE-2022-27646
Before looking into the details of how [Morion](https://github.com/pdamian/morion) might assist
during [exploit generation](./6_exploitation.md), this chapter provides essential **background
information** necessary for comprehending the targeted vulnerability. For a deeper exploration, we
direct the interested reader to the original writeup by the vulnerability discoverers, available at
[Defeating the NETGEAR R6700v3](https://www.synacktiv.com/en/publications/pwn2own-austin-2021-defeating-the-netgear-r6700v3.html).
## Description
[CVE-2022-27646](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-27646) corresponds to a
pre-authentication **Remote Code Execution (RCE)** vulnerability in NETGEAR R6700v3 routers 
(version 10.04.120_10.0.91) that might be exploited over the WAN interface.

The vulnerability resides in a binary `/bin/circled`, which occasionally fetches a file named
`circleinfo.txt` from a remote web server. During parsing of the downloaded file, a **stack buffer
overflow** might occur, due to some incorrect handling of buffer sizes. Since the download request
initiated by binary `circled` misses **certificate validation**
(see [CVE-2022-27644](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-27644)), attackers
could trick vulnerable routers to download a malicious file (e.g. using DNS or TCP redirection),
leading to arbitrary code being executed on the router. Since `circled` runs as root, attackers may
gain full privileges on the targeted routers.
## Analysis

<figure>
  <img src="../images/RE_Vuln_01.svg" alt=""/>
  <figcaption>
    Fig. 1: TODO - TODO.
  </figcaption>
</figure>

<figure>
  <img src="../images/RE_Vuln_02.svg" alt=""/>
  <figcaption>
    Fig. 2: TODO - TODO.
  </figcaption>
</figure>

<figure>
  <img src="../images/RE_Vuln_03.svg" alt=""/>
  <figcaption>
    Fig. 3: TODO - TODO.
  </figcaption>
</figure>

We traced from the point where `/tmp/circleinfo.txt` has been opened to the point where function
`updating_database` returned.

## Memory Layout PoV
PoV Payload: `b'A'*1021 + b' X'`

1. `fgets [1024]`: 
2. ``

      char *fgets(char *restrict s, int n, FILE *restrict stream);
       The fgets() function shall read bytes from stream into the array
       pointed to by s until n-1 bytes are read, or a <newline> is read
       and transferred to s, or an end-of-file condition is encountered.
       A null byte shall be written immediately after the last byte read
       into the array.  If the end-of-file condition is encountered
       before any bytes are read, the contents of the array pointed to
       by s shall not be changed.

<figure>
  <img src="../images/Memory_Layout-PoV.svg" alt="Memory Layout PoV"/>
  <figcaption>
    Fig. 1: Memory Layout - Showing the stack layout for the proof-of-vulnerability (PoV) payload.
  </figcaption>
</figure>

----------------------------------------------------------------------------------------------------
[Back-to-Top](./5_vulnerability.md#table-of-contents)